import os
import json
import requests
import openai
import logging
from datetime import datetime
from dotenv import load_dotenv
from telegram import Update
from telegram.ext import ApplicationBuilder, CommandHandler, ContextTypes

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.DEBUG,  # –ò–∑–º–µ–Ω–∏–ª–∏ –Ω–∞ DEBUG –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞
    handlers=[
        logging.StreamHandler(),  # –í—ã–≤–æ–¥ –≤ –∫–æ–Ω—Å–æ–ª—å
        logging.FileHandler('bot.log')  # –ó–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª
    ])
logger = logging.getLogger(__name__)

# –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
load_dotenv()
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
TG_TOKEN = os.getenv("TELEGRAM_TOKEN")
API_KEY = os.getenv("CRYPTORANK_API_KEY")
MAIN_DB = 'crypto_projects_db.json'

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ OpenAI
openai.api_key = OPENAI_API_KEY


class CryptoAnalyzer:

    def __init__(self):
        self.db_file = MAIN_DB
        self.db = self._load_db()
        self.session = requests.Session()
        self.session.headers.update({
            'Accept': 'application/json',
            'User-Agent': 'Mozilla/5.0'
        })
        logger.debug("–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω CryptoAnalyzer")

    def _load_db(self):
        """–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        try:
            if os.path.exists(self.db_file):
                logger.debug(f"–ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏–∑ {self.db_file}")
                with open(self.db_file, 'r') as f:
                    data = json.load(f)
                    logger.debug(
                        f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(data.get('projects', {}))} –ø—Ä–æ–µ–∫—Ç–æ–≤")
                    return data
            logger.debug("–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é")
            return {'projects': {}, 'last_update': None}
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")
            return {'projects': {}, 'last_update': None}

    def _save_db(self):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        try:
            with open(self.db_file, 'w') as f:
                json.dump(self.db, f, indent=2)
            logger.debug(f"–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ {self.db_file}")
        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: {e}")

    def get_project_key(self, project):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞ –ø—Ä–æ–µ–∫—Ç–∞"""
        return str(project['id'])

    def is_unlisted(self, project):
        """–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –ª–∏—Å—Ç–∏–Ω–≥–∞ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ñ–ª–∞–≥ is_unlisted –≤ –ø—Ä–æ–µ–∫—Ç–µ
        if 'is_unlisted' in project:
            return project['is_unlisted']

        slug = project.get('slug')
        if not slug:
            logger.debug(f"–ü—Ä–æ–µ–∫—Ç {project.get('name')} –Ω–µ –∏–º–µ–µ—Ç slug")
            return True

        try:
            url = f"https://api.cryptorank.io/v1/currencies/{slug}/exchanges"
            logger.debug(f"–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Å—Ç–∏–Ω–≥–∞ –¥–ª—è {slug} –ø–æ URL: {url}")

            response = self.session.get(url,
                                        params={'api_key': API_KEY},
                                        timeout=15)
            logger.debug(f"–û—Ç–≤–µ—Ç API: {response.status_code}")

            if response.status_code == 404:
                logger.debug(f"–ü—Ä–æ–µ–∫—Ç {slug} –Ω–µ –∏–º–µ–µ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã exchanges")
                return True

            data = response.json().get('data', [])
            logger.debug(f"–ù–∞–π–¥–µ–Ω–æ {len(data)} –±–∏—Ä–∂ –¥–ª—è {slug}")

            return len(data) == 0

        except Exception as e:
            logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∏—Å—Ç–∏–Ω–≥–∞ –¥–ª—è {slug}: {e}")
            return True

    def fetch_projects(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å API —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–ª–æ–≥–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        all_projects = []
        offset = 0
        chunk_size = 100
        total = 0

        logger.info("–ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å API Cryptorank")

        while True:
            try:
                params = {
                    'api_key': API_KEY,
                    'limit': chunk_size,
                    'offset': offset,
                    'sort': 'rank'
                }
                logger.debug(
                    f"–ó–∞–ø—Ä–æ—Å –ø—Ä–æ–µ–∫—Ç–æ–≤ (offset: {offset}, limit: {chunk_size})")

                response = self.session.get(
                    "https://api.cryptorank.io/v1/currencies",
                    params=params,
                    timeout=30)
                data = response.json().get('data', [])

                if not data:
                    logger.info(f"–ó–∞–≤–µ—Ä—à–µ–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞. –í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: {total}")
                    break

                all_projects.extend(data)
                count = len(data)
                total += count
                offset += count

                logger.info(f"–ó–∞–≥—Ä—É–∂–µ–Ω–æ {count} –ø—Ä–æ–µ–∫—Ç–æ–≤. –í—Å–µ–≥–æ: {total}")

            except Exception as e:
                logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–æ–µ–∫—Ç–æ–≤: {e}")
                break

        return all_projects

    def analyze_projects(self):
        """–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –ø–æ–¥—Ä–æ–±–Ω—ã–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        logger.info("–ù–∞—á–∞–ª–æ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ–µ–∫—Ç–æ–≤")
        projects = self.fetch_projects()
        new_unlisted = []
        total = len(self.db['projects'])

        for i, project in enumerate(projects, 1):
            key = self.get_project_key(project)
            if key in self.db['projects']:
                continue

            is_unlisted = self.is_unlisted(project)
            logger.debug(
                f"–ü—Ä–æ–µ–∫—Ç {project.get('name')} - unlisted: {is_unlisted}")

            project_data = {
                'id': project.get('id'),
                'name': project.get('name'),
                'symbol': project.get('symbol'),
                'url': f"https://cryptorank.io/price/{project.get('slug')}",
                'exchanges_url':
                f"https://cryptorank.io/price/{project.get('slug')}/exchanges",
                'description': project.get('description', '–Ω–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'),
                'industry': project.get('industry', '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'),
                'investors': project.get('investors', []),
                'is_unlisted': is_unlisted,
                'priceUsd': project.get('priceUsd'),
                'added': datetime.now().strftime('%Y-%m-%d %H:%M')
            }

            self.db['projects'][key] = project_data
            if is_unlisted:
                new_unlisted.append(project_data)
                logger.info(
                    f"–ù–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞: {project.get('name')}")

            if i % 100 == 0:
                logger.info(
                    f"–û–±—Ä–∞–±–æ—Ç–∞–Ω–æ {i} –ø—Ä–æ–µ–∫—Ç–æ–≤. –ù–æ–≤—ã—Ö –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞: {len(new_unlisted)}"
                )

        self.db['last_update'] = datetime.now().strftime('%Y-%m-%d %H:%M')
        self._save_db()

        logger.info(
            f"–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω. –í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: {len(self.db['projects'])}. –ù–æ–≤—ã—Ö –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞: {len(new_unlisted)}"
        )
        return new_unlisted

    def get_all_unlisted(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–µ–∑–∞–ª–∏—Å—Ç–∏–≤—à–∏—Ö—Å—è –ø—Ä–æ–µ–∫—Ç–æ–≤"""
        unlisted = [
            p for p in self.db['projects'].values() if p['is_unlisted']
        ]
        logger.debug(f"–ü–æ–ª—É—á–µ–Ω–æ {len(unlisted)} –ø—Ä–æ–µ–∫—Ç–æ–≤ –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞")
        return unlisted

    def get_new_unlisted(self):
        """–ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö –Ω–µ–∑–∞–ª–∏—Å—Ç–∏–≤—à–∏—Ö—Å—è –ø—Ä–æ–µ–∫—Ç–æ–≤"""
        unlisted = [
            p for p in self.db['projects'].values()
            if p['is_unlisted'] and p['added'] == self.db['last_update']
        ]
        logger.debug(f"–ü–æ–ª—É—á–µ–Ω–æ {len(unlisted)} –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞")
        return unlisted

    def generate_ai_report(self, projects):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è AI –æ—Ç—á–µ—Ç–∞ —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º"""
        logger.info(f"–ù–∞—á–∞–ª–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ AI –æ—Ç—á–µ—Ç–∞ –¥–ª—è {len(projects)} –ø—Ä–æ–µ–∫—Ç–æ–≤")
        report = []

        for i, project in enumerate(projects[:20], 1):
            try:
                logger.debug(
                    f"–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞ {i}/{len(projects)}: {project['name']}")

                prompt = (
                    f"–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫—Ä–∏–ø—Ç–æ–ø—Ä–æ–µ–∫—Ç –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞:\n"
                    f"–ù–∞–∑–≤–∞–Ω–∏–µ: {project['name']}\n"
                    f"–°–∏–º–≤–æ–ª: {project['symbol']}\n"
                    f"–û–ø–∏—Å–∞–Ω–∏–µ: {project['description']}\n"
                    f"–ò–Ω–¥—É—Å—Ç—Ä–∏—è: {project['industry']}\n"
                    f"–ò–Ω–≤–µ—Å—Ç–æ—Ä—ã: {', '.join(project['investors']) if project['investors'] else '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã'}\n\n"
                    "–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç –Ω–µ –∏–º–µ–µ—Ç –ª–∏—Å—Ç–∏–Ω–≥–∞ –Ω–∞ –±–∏—Ä–∂–∞—Ö. –û—Ü–µ–Ω–∏ –µ–≥–æ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª."
                )

                response = openai.ChatCompletion.create(
                    model="gpt-3.5-turbo",
                    messages=[{
                        "role": "system",
                        "content": "–¢—ã –∫—Ä–∏–ø—Ç–æ–∞–Ω–∞–ª–∏—Ç–∏–∫."
                    }, {
                        "role": "user",
                        "content": prompt
                    }],
                    temperature=0.7)

                analysis = response.choices[0].message.content
                report.append(f"üîπ {project['name']} ({project['symbol']})\n"
                              f"üîó {project['url']}\n"
                              f"üìå –ë–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞\n\n"
                              f"{analysis}\n"
                              f"{'-'*40}\n")

                logger.debug(
                    f"–£—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ø—Ä–æ–µ–∫—Ç {project['name']}")

            except Exception as e:
                error_msg = f"–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ {project['name']}: {str(e)}"
                report.append(f"‚ö†Ô∏è {error_msg}")
                logger.error(error_msg)

        logger.info("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è AI –æ—Ç—á–µ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞")
        return "\n".join(report)


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ Telegram
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start"""
    logger.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /start –æ—Ç {update.effective_user.id}")
    await update.message.reply_text(
        "üîç –ë–æ—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –Ω–µ–∑–∞–ª–∏—Å—Ç–∏–≤—à–∏—Ö—Å—è –ø—Ä–æ–µ–∫—Ç–æ–≤\n\n"
        "–ö–æ–º–∞–Ω–¥—ã:\n"
        "/update - –û–±–Ω–æ–≤–∏—Ç—å –±–∞–∑—É\n"
        "/unlisted - –ü–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞\n"
        "/unlisted_all - –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞\n"
        "/ai_report - AI –∞–Ω–∞–ª–∏–∑ –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤")


async def update_db(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"""
    logger.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /update –æ—Ç {update.effective_user.id}")
    analyzer = CryptoAnalyzer()
    msg = await update.message.reply_text("üîÑ –û–±–Ω–æ–≤–ª—è—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...")

    try:
        new_unlisted = analyzer.analyze_projects()
        response = (f"‚úÖ –ë–∞–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞\n"
                    f"–í—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–æ–≤: {len(analyzer.db['projects'])}\n"
                    f"–ù–æ–≤—ã—Ö –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞: {len(new_unlisted)}")
        logger.info(response)
        await msg.edit_text(response)
    except Exception as e:
        error_msg = f"‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±–∞–∑—ã: {str(e)}"
        logger.error(error_msg)
        await msg.edit_text(error_msg)


async def show_unlisted(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å –Ω–æ–≤—ã–µ –Ω–µ–∑–∞–ª–∏—Å—Ç–∏–≤—à–∏–µ—Å—è –ø—Ä–æ–µ–∫—Ç—ã"""
    logger.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /unlisted –æ—Ç {update.effective_user.id}")
    analyzer = CryptoAnalyzer()

    try:
        unlisted = analyzer.get_new_unlisted()
        if not unlisted:
            msg = "‚úÖ –ù–µ—Ç –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞"
            logger.debug(msg)
            await update.message.reply_text(msg)
            return

        message = "üìã –ù–æ–≤—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞:\n\n" + "\n".join(
            f"{i}. {p['name']} - {p['url']}"
            for i, p in enumerate(unlisted[:15], 1))

        logger.debug(f"–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–∑ {len(unlisted)} –ø—Ä–æ–µ–∫—Ç–æ–≤")
        await update.message.reply_text(message)

    except Exception as e:
        error_msg = f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞: {str(e)}"
        logger.error(error_msg)
        await update.message.reply_text(error_msg)


async def show_all_unlisted(update: Update,
                            context: ContextTypes.DEFAULT_TYPE):
    """–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞"""
    logger.debug(
        f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /unlisted_all –æ—Ç {update.effective_user.id}")
    analyzer = CryptoAnalyzer()

    try:
        unlisted = analyzer.get_all_unlisted()
        if not unlisted:
            msg = "‚úÖ –ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤ –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞"
            logger.debug(msg)
            await update.message.reply_text(msg)
            return

        message = "üìã –í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã –±–µ–∑ –ª–∏—Å—Ç–∏–Ω–≥–∞:\n\n" + "\n".join(
            f"{i}. {p['name']} - {p['url']}\n–î–æ–±–∞–≤–ª–µ–Ω: {p['added']}"
            for i, p in enumerate(unlisted, 1))

        logger.debug(f"–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞ –∏–∑ {len(unlisted)} –ø—Ä–æ–µ–∫—Ç–æ–≤")

        # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ 2000 —Å–∏–º–≤–æ–ª–æ–≤
        for i in range(0, len(message), 2000):
            await update.message.reply_text(message[i:i + 2000])

    except Exception as e:
        error_msg = f"‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞: {str(e)}"
        logger.error(error_msg)
        await update.message.reply_text(error_msg)


async def ai_report(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """AI –∞–Ω–∞–ª–∏–∑ –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤"""
    logger.debug(f"–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥—ã /ai_report –æ—Ç {update.effective_user.id}")
    analyzer = CryptoAnalyzer()
    msg = await update.message.reply_text("ü§ñ AI –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—Ä–æ–µ–∫—Ç—ã...")

    try:
        unlisted = analyzer.get_new_unlisted()
        if not unlisted:
            response = "‚úÖ –ù–µ—Ç –Ω–æ–≤—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞"
            logger.debug(response)
            await msg.edit_text(response)
            return

        logger.info(f"–ù–∞—á–∞–ª–æ AI –∞–Ω–∞–ª–∏–∑–∞ –¥–ª—è {len(unlisted)} –ø—Ä–æ–µ–∫—Ç–æ–≤")
        report = analyzer.generate_ai_report(unlisted)

        # –†–∞–∑–±–∏–≤–∞–µ–º –æ—Ç—á–µ—Ç –Ω–∞ —á–∞—Å—Ç–∏
        for i in range(0, len(report), 4000):
            await update.message.reply_text(report[i:i + 4000])

        response = "üìä AI –∞–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω"
        logger.info(response)
        await msg.edit_text(response)

    except Exception as e:
        error_msg = f"‚ùå –û—à–∏–±–∫–∞ AI –∞–Ω–∞–ª–∏–∑–∞: {str(e)}"
        logger.error(error_msg)
        await msg.edit_text(error_msg)


def main():
    """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫"""
    try:
        logger.info("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
        app = ApplicationBuilder().token(TG_TOKEN).build()

        app.add_handler(CommandHandler("start", start))
        app.add_handler(CommandHandler("update", update_db))
        app.add_handler(CommandHandler("unlisted", show_unlisted))
        app.add_handler(CommandHandler("unlisted_all", show_all_unlisted))
        app.add_handler(CommandHandler("ai_report", ai_report))

        logger.info("–ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω")
        app.run_polling()

    except Exception as e:
        logger.critical(f"–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {str(e)}")
        raise


if __name__ == '__main__':
    main()
